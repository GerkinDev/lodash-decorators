{"version":3,"file":"DecoratorFactory.js","sourceRoot":"","sources":["../../../src/factory/DecoratorFactory.ts"],"names":[],"mappings":"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","sourcesContent":["import isFunction from 'lodash/isFunction';\n\nimport {\n  InstanceChainMap,\n  LodashDecorator,\n  InstanceChainContext\n} from './common';\nimport { DecoratorConfig } from './DecoratorConfig';\nimport {\n  copyMetadata,\n  bind,\n  isMethodOrPropertyDecoratorArgs,\n  isPrototypeAccess\n} from '../utils';\n\nexport type GenericDecorator = (...args: any[]) => LodashDecorator;\n\nexport class InternalDecoratorFactory {\n  createDecorator(config: DecoratorConfig): GenericDecorator {\n    const { applicator, optionalParams } = config;\n\n    return (...args: any[]): LodashDecorator => {\n      let params = args;\n\n      const decorator = (target: Object, name: string, _descriptor?: PropertyDescriptor): PropertyDescriptor => {\n        const descriptor = this._resolveDescriptor(target, name, _descriptor);\n        const { value, get, set } = descriptor;\n\n        // If this decorator is being applied after an instance decorator we simply ignore it\n        // as we can't apply it correctly.\n        if (!InstanceChainMap.has([ target, name ])) {\n          if (isFunction(value)) {\n            descriptor.value = copyMetadata(applicator.apply({ config, target, value, args: params }), value);\n          } else if (isFunction(get) && config.getter) {\n            descriptor.get = copyMetadata(applicator.apply({ config, target, value: get, args: params }), get);\n          } else if (isFunction(set) && config.setter) {\n            descriptor.set = copyMetadata(applicator.apply({ config, target, value: set, args: params }), set);\n          }\n        }\n\n        return descriptor;\n      };\n\n      if (optionalParams && isMethodOrPropertyDecoratorArgs(...args)) {\n        params = [];\n\n        return decorator(args[0], args[1], args[2]) as any;\n      }\n\n      return decorator;\n    };\n  }\n\n  createInstanceDecorator(config: DecoratorConfig): GenericDecorator {\n    const { applicator, bound, optionalParams } = config;\n\n    return (...args: any[]): LodashDecorator => {\n      let params = args;\n      const decorator = (target: Object, name: string, _descriptor?: PropertyDescriptor): PropertyDescriptor => {\n        const descriptor = this._resolveDescriptor(target, name, _descriptor);\n        const { value, writable, enumerable, configurable, get, set } = descriptor;\n        const isFirstInstance = !InstanceChainMap.has([ target, name ]);\n        const chainData = InstanceChainMap.get([ target, name ]) || { fns: [], properties: [] };\n        const isGetter = isFirstInstance && isFunction(get);\n        const isSetter = isFirstInstance && isFunction(set);\n        const isMethod = isFirstInstance && isFunction(value);\n        const isProperty = isFirstInstance && !isGetter && !isSetter && !isMethod;\n        const baseValue = isGetter ? get : isMethod ? value : undefined;\n\n        chainData.properties.push(name);\n        chainData.fns.push((fn: Function, instance: any, context: InstanceChainContext) => {\n          if (!this._isApplicable(context, config)) {\n            return fn;\n          }\n\n          if (bound) {\n            fn = bind(fn, instance);\n          }\n\n          return copyMetadata(\n            applicator.apply({ args: params, target, instance, value: fn, config }),\n            fn\n          );\n        });\n\n        InstanceChainMap.set([ target, name ], chainData);\n\n        if (!isFirstInstance) {\n          return descriptor;\n        }\n\n        chainData.isSetter = isSetter;\n        chainData.isGetter = isGetter;\n        chainData.isMethod = isMethod;\n        chainData.isProperty = isProperty;\n\n        const applyChain = (fn: any, context: InstanceChainContext, instance: any) => {\n          return chainData.fns.reduce((result: Function, next: Function) => next(result, instance, context), fn);\n        };\n\n        const applyDecorator = (instance: any) => {\n          let getter = get || undefined;\n          let setter = set || undefined;\n\n          if (isGetter || isSetter) {\n            // If we have a getter apply the decorators to the getter and assign it to the instance.\n            if (isGetter) {\n              getter = applyChain(get, { value: get, getter: true }, instance);\n            }\n\n            if (isSetter) {\n              setter = applyChain(set, { value: set, setter: true }, instance);\n            }\n\n            Object.defineProperty(instance, name, {\n              enumerable,\n              configurable,\n              get: getter,\n              set: setter\n            });\n          } else if (isMethod || isProperty) {\n            const newFn = isMethod\n              ? applyChain(value, { value, method: true }, instance)\n              : applyChain(value, { value, property: true }, instance);\n\n            Object.defineProperty(instance, name, {\n              writable,\n              enumerable,\n              configurable,\n              value: newFn\n            });\n          }\n        };\n\n        if (isMethod || isProperty) {\n          delete descriptor.value;\n          delete descriptor.writable;\n        }\n\n        descriptor.get = function() {\n          // Check for direct access on the prototype.\n          // MyClass.prototype.fn <-- This should not apply the decorator.\n          if (isPrototypeAccess(this, target)) {\n            return baseValue;\n          }\n\n          applyDecorator(this);\n\n          const descriptor2 = Object.getOwnPropertyDescriptor(this, name)!;\n\n          if (descriptor2.get) {\n            return descriptor2.get.call(this);\n          }\n\n          return descriptor2.value;\n        };\n\n        descriptor.set = function(value2) {\n          applyDecorator(this);\n\n          const descriptor2 = Object.getOwnPropertyDescriptor(this, name)!;\n\n          if (descriptor2.set) {\n            descriptor2.set.call(this, value2);\n          } else if (isProperty || isMethod) {\n            this[name] = value2;\n          }\n        };\n\n        return descriptor;\n      };\n\n      if (optionalParams && isMethodOrPropertyDecoratorArgs(...args)) {\n        params = [];\n\n        return decorator(args[0], args[1], args[2]) as any;\n      }\n\n      return decorator;\n    };\n  }\n\n  private _isApplicable(context: InstanceChainContext, config: DecoratorConfig): boolean {\n   return !Boolean(\n     context.getter && !config.getter\n      || context.setter && !config.setter\n      || context.method && !config.method\n      || context.property && !config.property\n   );\n  }\n\n  private _resolveDescriptor(target: Object, name: string, descriptor?: PropertyDescriptor): PropertyDescriptor {\n    if (descriptor) {\n      return descriptor;\n    }\n\n    return Object.getOwnPropertyDescriptor(target, name) || {};\n  }\n}\n\nexport const DecoratorFactory = new InternalDecoratorFactory();\n"]}